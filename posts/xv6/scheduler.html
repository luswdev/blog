<!DOCTYPE html>
<html lang="zh-TW">
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!--Description-->



    <meta name="description" content="Notes of single-chip microcompute, RTOS and Firmware.">


<!--Author-->

    <meta name="author" content="LuSkywalker">


<!--Open Graph Title-->

    <meta property="og:title" content="XV6 - Scheduling">


<!--Open Graph Description-->

    <meta property="og:description" content="Notes of single-chip microcompute, RTOS and Firmware.">


<!--Open Graph Site Name-->
    <meta property="og:site_name" content="HackTech">

<!--Type page-->

    <meta property="og:type" content="article">


<!--Page Cover-->


    <meta property="og:image" content="https://blog.lusw.dev/img/home-bg.jpg">


<meta name="twitter:card" content="summary_large_image">




    <meta name="twitter:image" content="https://blog.lusw.dev/img/home-bg.jpg">


<!-- Title -->

<title>XV6 - Scheduling | HackTech</title>

<!-- Bootstrap Core CSS -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">

<!-- Custom CSS -->
<link rel="stylesheet" href="/css/main.css">

<!-- Custom Fonts -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.0/css/all.min.css">
<link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.0/css/all.min.css">
<link href="//fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
<link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Gallery -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/featherlight@1.4.0/src/featherlight.css" integrity="sha256-30DV/STftlyQ6v8yaOWlabammvCYtRJERLj/m0b3zno=" crossorigin="anonymous">
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/lightgallery@1.6.11/dist/css/lightgallery.min.css">

<!-- favicon -->

<link rel="icon" href="/img/favicon.png">



    <!-- Google Analytics -->
    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-158078787-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-158078787-1');
</script>



<link rel="alternate" href="/atom.xml" title="HackTech" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<!-- Head tag -->

<body>

    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top bg-transparent position-absolute w-100 p-0" id="nav">
    <div class="container pl-0 pr-0">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <a class="navbar-brand text-white p-1 pl-3" href="/">LuSkywalker</a>
        </div>
        <div class="navbar-nav float-right">
            <button class="btn btn-link search-btn navbar-item" data-toggle="modal" data-target="#searchModal">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12 text-center">
                <div class="post-heading text-white">
                    <h1>XV6 - Scheduling</h1>
                    
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Main Content -->
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
                
                    <span class="meta d-inline-block">
    
        <i class="far fa-bookmark fa-fw"></i>
        

<a href="/categories/XV6/">XV6</a>

    
    
    <!-- Date -->
    
        <span class="post-meta-split">&nbsp;|&nbsp;</span>
        <i class="far fa-calendar-check fa-fw"></i>
        2018-08-14
    
    <!-- word count and read count -->
    
        <span class="post-meta-split">&nbsp;|&nbsp;</span>
        <i class="far fa-file-word fa-fw"></i>
        2.6k
    

    

    
</span>  
                
                <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="Multiplexing">Multiplexing<a class="header-anchor" href="#Multiplexing">#</a></h2>
<ul>
<li>如果 process 需要等待 I/O 或是子 process 結束，XV6 讓其進入睡眠狀態，接著將處理器 switch 給其他 process。</li>
<li>此機制使 process 有獨佔 CPU 的假象。</li>
<li>完成 switch 的動作由 context switch 完成：
<ul>
<li>透明化 -&gt; 使用 <strong>timer interrupt handler</strong> 驅動 context switch。</li>
<li>同時多個 process 需要 switch -&gt; lock</li>
</ul>
</li>
</ul>
<hr>
<h2 id="Code-Context-switch">Code: Context switch<a class="header-anchor" href="#Code-Context-switch">#</a></h2>
<ul>
<li>從 process 的 kernel stack -&gt; schedluler kernel stack (CPU) -&gt; 另一個 process 的 kernel stack。</li>
<li>永遠不會從 process 的 kernel stack -&gt; process 的 kernel stack。</li>
</ul>
<p><div class="img-item" data-src="https://i.imgur.com/qtfH1Vj.png" data-sub-html=".caption"><img src="https://i.imgur.com/qtfH1Vj.png" alt="context switch" title="Switching from one user process to another."><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">context switch</span></div></div></p>
<ul>
<li>每個 process 都有自己的 kernel stack 及暫存器集合，每個 CPU 有自己的 scheduler stack。</li>
<li>context 即 process 的暫存器集合，用一個 <code>struct context *</code> 表示。</li>
</ul>
<div class="alert alert-success"><p><strong>File:</strong> proc.h</p></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span> {</span></span><br><span class="line">  uint edi;</span><br><span class="line">  uint esi;</span><br><span class="line">  uint ebx;</span><br><span class="line">  uint ebp;</span><br><span class="line">  uint eip;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>trap 有可能會呼叫 <code>yield</code>，<code>yield</code> 會呼叫 <code>sched</code>，最後 <code>sched</code> 呼叫 <code>swtch(&amp;proc-&gt;context, cpu-&gt;scheduler);</code>。</li>
</ul>
<h3 id="File-swtch-S">File: swtch.S<a class="header-anchor" href="#File-swtch-S">#</a></h3>
<ul>
<li><em>swtch</em> 有兩個參數：<code>struct context ** old</code>、<code>struct context * new</code>。</li>
</ul>
<figure class="highlight x86asm line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Context switch</span><br><span class="line">#</span><br><span class="line">#   void swtch(struct context **old, struct context *new)<span class="comment">;</span></span><br><span class="line"># </span><br><span class="line"># Save current register context <span class="keyword">in</span> old</span><br><span class="line"># <span class="keyword">and</span> then load register context from new.</span><br><span class="line"></span><br><span class="line"><span class="meta">.globl</span> swtch</span><br><span class="line"><span class="symbol">swtch:</span></span><br><span class="line">  movl <span class="number">4</span>(%esp), %eax</span><br><span class="line">  movl <span class="number">8</span>(%esp), %edx</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>將 <code>%eax</code> 指向 <code>struct context ** old</code>，<code>%ebx</code> 指向 <code>struct context * new</code>。</li>
</ul>
<p><div class="img-item" data-src="https://i.imgur.com/0QWW7gZ.png" data-sub-html=".caption"><img src="https://i.imgur.com/0QWW7gZ.png" alt="swtch" title="Context switch step. 1"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">swtch</span></div></div></p>
<figure class="highlight x86asm line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Save old callee-save registers</span><br><span class="line">pushl %ebp</span><br><span class="line">pushl %ebx</span><br><span class="line">pushl %esi</span><br><span class="line">pushl %edi</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>依序將 context push 進堆疊</li>
</ul>
<p><div class="img-item" data-src="https://i.imgur.com/CXUNIYY.png" data-sub-html=".caption"><img src="https://i.imgur.com/CXUNIYY.png" alt="swtch" title="Context switch step. 2"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">swtch</span></div></div></p>
<figure class="highlight x86asm line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># Switch stacks</span><br><span class="line">movl %esp, (%eax)</span><br><span class="line">movl %edx, %esp</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>將 <code>struct context ** old</code>（<code>%eax</code>） 指向 <code>%esp</code>（當前堆疊的 <strong>top</strong>）</li>
<li>將 <code>%esp</code> 指向 <code>struct context * new</code>（<code>%ebx</code>）</li>
</ul>
<p><div class="img-item" data-src="https://i.imgur.com/AB38T7t.png" data-sub-html=".caption"><img src="https://i.imgur.com/AB38T7t.png" alt="swtch" title="Context switch step. 3"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">swtch</span></div></div></p>
<figure class="highlight x86asm line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># Load new callee-save registers</span><br><span class="line">popl %edi</span><br><span class="line">popl %esi</span><br><span class="line">popl %ebx</span><br><span class="line">popl %ebp</span><br><span class="line"><span class="keyword">ret</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>恢復保存的暫存器，用<code>ret</code> 指令跳回</li>
</ul>
<hr>
<h2 id="Scheduling">Scheduling<a class="header-anchor" href="#Scheduling">#</a></h2>
<ul>
<li>process 要讓出 CPU 前需要先取得 ptable.lock，釋放其他擁有的鎖，修改 p-&gt;state，呼叫 <code>sched</code>。</li>
<li><code>sched</code> 會再次檢查以上動作，並且確定此時中斷是關閉的，最後呼叫 <code>swtch</code>，將 process 的暫存器保存在 proc-&gt;context，switch 到 cpu-&gt;scheduler。</li>
</ul>
<div class="alert alert-success"><p><strong>File:</strong> proc.c</p></div>
<h3 id="sched">sched<a class="header-anchor" href="#sched">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody>
<tr>
<td>檢查並跳至 swtch.h</td>
<td>void</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">sched(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">int</span> intena;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!holding(&amp;ptable.lock))</span><br><span class="line">    panic(<span class="string">"sched ptable.lock"</span>);</span><br><span class="line">  <span class="keyword">if</span>(cpu-&gt;ncli != <span class="number">1</span>)</span><br><span class="line">    panic(<span class="string">"sched locks"</span>);</span><br><span class="line">  <span class="keyword">if</span>(proc-&gt;state == RUNNING)</span><br><span class="line">    panic(<span class="string">"sched running"</span>);</span><br><span class="line">  <span class="keyword">if</span>(readeflags()&amp;FL_IF)</span><br><span class="line">    panic(<span class="string">"sched interruptible"</span>);</span><br><span class="line">  intena = cpu-&gt;intena;</span><br><span class="line">  swtch(&amp;proc-&gt;context, cpu-&gt;scheduler);</span><br><span class="line">  cpu-&gt;intena = intena;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>swtch</code> 會 return 回 scheduler 的堆疊上，scheduler 繼續執行迴圈：找到一個 process 運行，<code>swtch</code> 到該 process，repeat。</li>
</ul>
<h3 id="scheduler">scheduler<a class="header-anchor" href="#scheduler">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody>
<tr>
<td>執行調度，指定執行的 process</td>
<td>void</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">scheduler(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(;;){</span><br><span class="line">    <span class="comment">// Enable interrupts on this processor.</span></span><br><span class="line">    sti();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop over process table looking for process to run.</span></span><br><span class="line">    acquire(&amp;ptable.lock);</span><br><span class="line">    <span class="keyword">for</span>(p = ptable.proc; p &lt; &amp;ptable.proc[NPROC]; p++){</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;state != RUNNABLE)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Switch to chosen process.  It is the process's job</span></span><br><span class="line">      <span class="comment">// to release ptable.lock and then reacquire it</span></span><br><span class="line">      <span class="comment">// before jumping back to us.</span></span><br><span class="line">      proc = p;</span><br><span class="line">      switchuvm(p);</span><br><span class="line">      p-&gt;state = RUNNING;</span><br><span class="line">      swtch(&amp;cpu-&gt;scheduler, proc-&gt;context);</span><br><span class="line">      switchkvm();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Process is done running for now.</span></span><br><span class="line">      <span class="comment">// It should have changed its p-&gt;state before coming back.</span></span><br><span class="line">      proc = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    release(&amp;ptable.lock);</span><br><span class="line"></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>scheduler</code> 找到一個 <code>RUNNABLE</code> 的 process，將 per-cpu 設為此 process，呼叫 <code>switchuvm</code> 切換到該 process 的頁表，更新狀態為<code>RUNNING</code>，<code>swtch</code> 到該 process 中運行。</li>
</ul>
<hr>
<h2 id="Code-mycpu-and-myproc">Code:  mycpu  and  myproc<a class="header-anchor" href="#Code-mycpu-and-myproc">#</a></h2>
<ul>
<li>CPU 需要辨識目前正在執行的 process，XV6 有一個 struct cpu 的陣列，裡面包含了一些 CPU 的資訊，及當前 process 的資訊。</li>
<li><code>mycpu</code> 尋找當前的 <code>lapicid</code> 是哪顆 CPU 的。</li>
</ul>
<h3 id="mycpu">mycpu<a class="header-anchor" href="#mycpu">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody>
<tr>
<td>找到目前所在的 CPU</td>
<td>CPU 結構指標</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cpu</span>*</span></span><br><span class="line"><span class="class"><span class="title">mycpu</span>(<span class="title">void</span>)</span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">int</span> apicid, i;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(readeflags()&amp;FL_IF)</span><br><span class="line">    panic(<span class="string">"mycpu called with interrupts enabled\n"</span>);</span><br><span class="line">  </span><br><span class="line">  apicid = lapicid();</span><br><span class="line">  <span class="comment">// APIC IDs are not guaranteed to be contiguous. Maybe we should have</span></span><br><span class="line">  <span class="comment">// a reverse map, or reserve a register to store &amp;cpus[i].</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ncpu; ++i) {</span><br><span class="line">    <span class="keyword">if</span> (cpus[i].apicid == apicid)</span><br><span class="line">      <span class="keyword">return</span> &amp;cpus[i];</span><br><span class="line">  }</span><br><span class="line">  panic(<span class="string">"unknown apicid\n"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>myproc</code> 呼叫 <code>mycpu</code>，從正確的 CPU 上尋找當前的 process。</li>
</ul>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody>
<tr>
<td>找到當前的 process</td>
<td>proc 結構指標</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span>*</span></span><br><span class="line"><span class="class"><span class="title">myproc</span>(<span class="title">void</span>) {</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cpu</span> *<span class="title">c</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  pushcli();</span><br><span class="line">  c = mycpu();</span><br><span class="line">  p = c-&gt;proc;</span><br><span class="line">  popcli();</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<h2 id="睡眠與喚醒（例子）">睡眠與喚醒（例子）<a class="header-anchor" href="#睡眠與喚醒（例子）">#</a></h2>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">q</span> {</span></span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span>*</span><br><span class="line">send(struct q *q, <span class="keyword">void</span> *p)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">while</span>(q-&gt;ptr != <span class="number">0</span>)</span><br><span class="line">        ;</span><br><span class="line">    q-&gt;ptr = p;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span>*</span><br><span class="line">recv(struct q * q)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">void</span> *p;</span><br><span class="line">    <span class="keyword">while</span>((p = q-&gt;ptr) == <span class="number">0</span>)</span><br><span class="line">        ;</span><br><span class="line">    q-&gt;ptr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>send</code> 直到隊伍 <code>q</code> 為空時，將要傳送的資料 <code>p</code> 放入隊中，<code>recv</code> 直到 <code>q</code> 有東西時將資料取出，把 <code>q</code> 再次設為 <code>0</code></li>
<li>這允許不同的 process 交換資料，但是很耗資源。</li>
</ul>
<h3 id="方案-1">方案 1<a class="header-anchor" href="#方案-1">#</a></h3>
<ul>
<li>加入 <code>sleep</code> 及 <code>wakeup</code> 機制，<code>sleep(chan)</code> 將 process 在 <code>chan</code> 中睡眠（一個 wait channel），<code>wakeup(chan)</code> 將 <code>chan</code> 上睡眠的 process 喚醒。</li>
</ul>
<figure class="highlight diff"><table><tbody><tr><td class="code"><pre><span class="line">void*</span><br><span class="line">send(struct q *q, void *p)</span><br><span class="line">{</span><br><span class="line">    while(q-&gt;ptr != 0)</span><br><span class="line">        ;</span><br><span class="line">    q-&gt;ptr = p;</span><br><span class="line"><span class="addition">+    wakeup(q);    /*wake recv*/</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">void*</span><br><span class="line">recv(struct q *q)</span><br><span class="line">{</span><br><span class="line">    void *p;</span><br><span class="line">    while((p = q-&gt;ptr) == 0)</span><br><span class="line"><span class="addition">+        sleep(q);</span></span><br><span class="line">    q-&gt;ptr = 0;</span><br><span class="line">    return p;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>如此一來 <code>recv</code> 能讓出 CPU，直到有人（<code>send</code>）將它喚醒。</li>
</ul>
<div class="alert alert-danger"><p><strong>問題</strong>：遺失的喚醒：<br>
<div class="img-item" data-src="https://i.imgur.com/aPcvuOZ.png" data-sub-html=".caption"><img src="https://i.imgur.com/aPcvuOZ.png" alt="遺失的喚醒" title="Example lost wakeup problem"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">遺失的喚醒</span></div></div></p>
<ul>
<li>假設 <code>recv</code> 在 215 行查看隊伍，發現需要睡眠，就在要呼叫 <code>sleep</code> 之前發生中斷，<code>send</code> 在其他的 CPU 將資料放進隊伍中，呼叫 <code>wakeup</code>，發現沒有正在休眠的 process，於是不做事；接著 <code>recv</code> 終於呼叫 <code>sleep</code> 進入睡眠。</li>
<li>此時，<code>revc</code> 正在等待 <code>send</code> 將它喚醒，但是 <code>send</code> 正在等待隊伍清空，清空的動作須由 <code>recv</code> 完成（休眠中），於是就產生了 <strong>deadlock</strong>。</li>
</ul></div>
<h3 id="方案-2">方案 2<a class="header-anchor" href="#方案-2">#</a></h3>
<ul>
<li>讓 <code>send</code> 及 <code>recv</code> 在睡眠及喚醒前都持有鎖。</li>
</ul>
<figure class="highlight diff"><table><tbody><tr><td class="code"><pre><span class="line">struct q {</span><br><span class="line">    struct spinlock lock;</span><br><span class="line">    void *ptr;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">void *</span><br><span class="line">send(struct q *q, void *p)</span><br><span class="line">{</span><br><span class="line"><span class="addition">+    acquire(&amp;q-&gt;lock);</span></span><br><span class="line">    while(q-&gt;ptr != 0)</span><br><span class="line">        ;</span><br><span class="line">    q-&gt;ptr = p;</span><br><span class="line">    wakeup(q);</span><br><span class="line"><span class="addition">+    release(&amp;q-&gt;lock);</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">void*</span><br><span class="line">recv(struct q *q)</span><br><span class="line">{</span><br><span class="line">    void *p;</span><br><span class="line"><span class="addition">+    acquire(&amp;q-&gt;lock);</span></span><br><span class="line">    while((p = q-&gt;ptr) == 0)</span><br><span class="line">        sleep(q);</span><br><span class="line">    q-&gt;ptr = 0;</span><br><span class="line"><span class="addition">+    release(&amp;q-&gt;lock);</span></span><br><span class="line">    return p;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>但這一樣有問題：<code>recv</code> 帶著鎖進入睡眠，<code>send</code> 也同時需要鎖來喚醒，於是就產生了 <strong>deadlock</strong>。</li>
</ul>
<h3 id="方案-3">方案 3<a class="header-anchor" href="#方案-3">#</a></h3>
<ul>
<li>在 <code>sleep</code> 時一併釋放鎖，也就是將鎖當成參數傳進去。</li>
</ul>
<figure class="highlight diff"><table><tbody><tr><td class="code"><pre><span class="line">struct q {</span><br><span class="line">    struct spinlock lock;</span><br><span class="line">    void *ptr;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">void *</span><br><span class="line">send(struct q *q, void *p)</span><br><span class="line">{</span><br><span class="line">    acquire(&amp;q-&gt;lock);</span><br><span class="line">    while(q-&gt;ptr != 0)</span><br><span class="line">        ;</span><br><span class="line">    q-&gt;ptr = p;</span><br><span class="line">    wakeup(q);</span><br><span class="line">    release(&amp;q-&gt;lock);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">void*</span><br><span class="line">recv(struct q *q)</span><br><span class="line">{</span><br><span class="line">    void *p;</span><br><span class="line">    acquire(&amp;q-&gt;lock);</span><br><span class="line">    while((p = q-&gt;ptr) == 0)</span><br><span class="line"><span class="addition">+        sleep(q, &amp;q-&gt;lock);</span></span><br><span class="line">    q-&gt;ptr = 0;</span><br><span class="line">    release(&amp;q-&gt;lock);</span><br><span class="line">    return p;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<h2 id="Code-睡眠與喚醒">Code: 睡眠與喚醒<a class="header-anchor" href="#Code-睡眠與喚醒">#</a></h2>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>副程式</th>
<th>目標</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sleep</code></td>
<td>將狀態改成 <code>SLEEPING</code>，呼叫 <code>sched</code> 釋放 CPU</td>
</tr>
<tr>
<td><code>wakeup</code></td>
<td>尋找狀態為 <code>SLEEPING</code> 的 process，改成 <code>RUNNABLE</code></td>
</tr>
</tbody>
</table></div>
<h3 id="sleep">sleep<a class="header-anchor" href="#sleep">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody>
<tr>
<td>讓 process 睡眠</td>
<td>void</td>
</tr>
</tbody>
</table></div>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th><code>*chan</code></th>
<th><code>*lk</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>欲睡眠的頻道</td>
<td>持有的鎖</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">sleep(<span class="keyword">void</span> *chan, struct spinlock *lk)</span><br><span class="line">{</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> = <span class="title">myproc</span>();</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(p == <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">"sleep"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(lk == <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">"sleep without lk"</span>);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>首先確保 process 存在，及持有鎖。</li>
</ul>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(lk != &amp;ptable.lock){  <span class="comment">//DOC: sleeplock0</span></span><br><span class="line">  acquire(&amp;ptable.lock);  <span class="comment">//DOC: sleeplock1</span></span><br><span class="line">  release(lk);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>接著檢查是否持有 <code>ptable-&gt;lock</code>，如果沒有則要求一個，把 <code>lk</code> 釋出。</li>
</ul>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Go to sleep.</span></span><br><span class="line">p-&gt;chan = chan;</span><br><span class="line">p-&gt;state = SLEEPING;</span><br><span class="line"></span><br><span class="line">sched();</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>睡眠，並呼叫 <code>sched</code></li>
</ul>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Tidy up.</span></span><br><span class="line">  p-&gt;chan = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reacquire original lock.</span></span><br><span class="line">  <span class="keyword">if</span>(lk != &amp;ptable.lock){  <span class="comment">//DOC: sleeplock2</span></span><br><span class="line">    release(&amp;ptable.lock);</span><br><span class="line">    acquire(lk);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<h3 id="wakeup1">wakeup1<a class="header-anchor" href="#wakeup1">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
<th><code>*chan</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>叫醒頻道上的 process</td>
<td>void</td>
<td>頻道</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">wakeup1(<span class="keyword">void</span> *chan)</span><br><span class="line">{</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(p = ptable.proc; p &lt; &amp;ptable.proc[NPROC]; p++)</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;state == SLEEPING &amp;&amp; p-&gt;chan == chan)</span><br><span class="line">      p-&gt;state = RUNNABLE;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<h3 id="wakeup">wakeup<a class="header-anchor" href="#wakeup">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
<th><code>*chan</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>叫醒頻道上的 process</td>
<td>void</td>
<td>頻道</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">wakeup(<span class="keyword">void</span> *chan)</span><br><span class="line">{</span><br><span class="line">  acquire(&amp;ptable.lock);</span><br><span class="line">  wakeup1(chan);</span><br><span class="line">  release(&amp;ptable.lock);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>wakeup</code> 找到 <code>chan</code> 上在睡眠的 process，並喚醒。</li>
</ul>
<hr>
<h2 id="Code-Pipes">Code: Pipes<a class="header-anchor" href="#Code-Pipes">#</a></h2>
<div class="alert alert-success"><p><strong>File:</strong> pipe.c</p></div>
<ul>
<li>pipe 為一個結構，包含一個鎖，一個 <code>buf</code> 等。</li>
<li>當 pipe 為空時，<code>nread == nwrite</code></li>
<li>當 pipe 為滿時，<code>nwrite == nread % PIPESIZE</code></li>
</ul>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe</span> {</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="keyword">char</span> data[PIPESIZE];</span><br><span class="line">  uint nread;     <span class="comment">// number of bytes read</span></span><br><span class="line">  uint nwrite;    <span class="comment">// number of bytes written</span></span><br><span class="line">  <span class="keyword">int</span> readopen;   <span class="comment">// read fd is still open</span></span><br><span class="line">  <span class="keyword">int</span> writeopen;  <span class="comment">// write fd is still open</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<hr>
<h3 id="pipewrite">pipewrite<a class="header-anchor" href="#pipewrite">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody>
<tr>
<td>寫入 pipe</td>
<td>寫入的大小</td>
</tr>
</tbody>
</table></div>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th><code>*p</code></th>
<th><code>*addr</code></th>
<th><code>n</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>欲寫入的 pipe</td>
<td>欲寫入的值</td>
<td>欲寫入的大小</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">pipewrite(struct pipe *p, <span class="keyword">char</span> *addr, <span class="keyword">int</span> n)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;p-&gt;lock);</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; n; i++){</span><br><span class="line">    <span class="keyword">while</span>(p-&gt;nwrite == p-&gt;nread + PIPESIZE){  <span class="comment">//DOC: pipewrite-full</span></span><br><span class="line">      <span class="keyword">if</span>(p-&gt;readopen == <span class="number">0</span> || myproc()-&gt;killed){</span><br><span class="line">        release(&amp;p-&gt;lock);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      }</span><br><span class="line">      wakeup(&amp;p-&gt;nread);</span><br><span class="line">      sleep(&amp;p-&gt;nwrite, &amp;p-&gt;lock);  <span class="comment">//DOC: pipewrite-sleep</span></span><br><span class="line">    }</span><br><span class="line">    p-&gt;data[p-&gt;nwrite++ % PIPESIZE] = addr[i];</span><br><span class="line">  }</span><br><span class="line">  wakeup(&amp;p-&gt;nread);  <span class="comment">//DOC: pipewrite-wakeup1</span></span><br><span class="line">  release(&amp;p-&gt;lock);</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>首先須取得鎖。</li>
<li><code>pipewrite</code> 從 0 開始將資料讀入 <code>buf</code>，更新 <code>nwrite</code> 計數器，當 <code>buf</code> 滿了，則喚醒 <code>piperead</code> 並睡眠；或是讀入完畢，一樣喚醒 <code>pipiread</code>。</li>
</ul>
<hr>
<h3 id="piperead">piperead<a class="header-anchor" href="#piperead">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody>
<tr>
<td>讀取 pipe</td>
<td>讀入的大小</td>
</tr>
</tbody>
</table></div>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th><code>*p</code></th>
<th><code>*addr</code></th>
<th><code>n</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>欲讀取的 pipe</td>
<td>讀取資料存放區</td>
<td>欲讀入的大小</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">piperead(struct pipe *p, <span class="keyword">char</span> *addr, <span class="keyword">int</span> n)</span><br><span class="line">{</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;p-&gt;lock);</span><br><span class="line">  <span class="keyword">while</span>(p-&gt;nread == p-&gt;nwrite &amp;&amp; p-&gt;writeopen){  <span class="comment">//DOC: pipe-empty</span></span><br><span class="line">    <span class="keyword">if</span>(myproc()-&gt;killed){</span><br><span class="line">      release(&amp;p-&gt;lock);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line">    sleep(&amp;p-&gt;nread, &amp;p-&gt;lock); <span class="comment">//DOC: piperead-sleep</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; n; i++){  <span class="comment">//DOC: piperead-copy</span></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;nread == p-&gt;nwrite)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    addr[i] = p-&gt;data[p-&gt;nread++ % PIPESIZE];</span><br><span class="line">  }</span><br><span class="line">  wakeup(&amp;p-&gt;nwrite);  <span class="comment">//DOC: piperead-wakeup</span></span><br><span class="line">  release(&amp;p-&gt;lock);</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>首先須取得鎖。</li>
<li><code>piperead</code> 確認 pipe 是否為空，為空則進入睡眠。</li>
<li>當 pipe 不為空時，寫入資料，更新 <code>nread</code> 計數器。</li>
<li>讀取完畢後，喚醒 <code>pipewrite</code>。</li>
</ul>
<hr>
<h2 id="Code-Wait-exit-and-kill">Code: Wait, exit and kill<a class="header-anchor" href="#Code-Wait-exit-and-kill">#</a></h2>
<div class="alert alert-success"><p><strong>File:</strong> proc.c</p></div>
<h3 id="wait">wait<a class="header-anchor" href="#wait">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody>
<tr>
<td>等待子 process 結束</td>
<td>pid (ok) / -1 (err)</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">wait(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  <span class="keyword">int</span> havekids, pid;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">curproc</span> = <span class="title">myproc</span>();</span></span><br><span class="line">  </span><br><span class="line">  acquire(&amp;ptable.lock);</span><br><span class="line">  <span class="keyword">for</span>(;;){</span><br><span class="line">    <span class="comment">// Scan through table looking for exited children.</span></span><br><span class="line">    havekids = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(p = ptable.proc; p &lt; &amp;ptable.proc[NPROC]; p++){</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;parent != curproc)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      havekids = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;state == ZOMBIE){</span><br><span class="line">        <span class="comment">// Found one.</span></span><br><span class="line">        pid = p-&gt;pid;</span><br><span class="line">        kfree(p-&gt;kstack);</span><br><span class="line">        p-&gt;kstack = <span class="number">0</span>;</span><br><span class="line">        freevm(p-&gt;pgdir);</span><br><span class="line">        p-&gt;pid = <span class="number">0</span>;</span><br><span class="line">        p-&gt;parent = <span class="number">0</span>;</span><br><span class="line">        p-&gt;name[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        p-&gt;killed = <span class="number">0</span>;</span><br><span class="line">        p-&gt;state = UNUSED;</span><br><span class="line">        release(&amp;ptable.lock);</span><br><span class="line">        <span class="keyword">return</span> pid;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No point waiting if we don't have any children.</span></span><br><span class="line">    <span class="keyword">if</span>(!havekids || curproc-&gt;killed){</span><br><span class="line">      release(&amp;ptable.lock);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wait for children to exit.  (See wakeup1 call in proc_exit.)</span></span><br><span class="line">    sleep(curproc, &amp;ptable.lock);  <span class="comment">//DOC: wait-sleep</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>首先須取得鎖。</li>
<li>接著尋找是否有子 process，如果有，並且還沒退出，則睡眠，等待子 process 退出。</li>
<li>如果找到已退出的子 process，紀錄該子 process 的 pid，清理 <code>struct proc</code>，釋放相關記憶體。</li>
</ul>
<hr>
<h3 id="exit">exit<a class="header-anchor" href="#exit">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
</tr>
</thead>
<tbody>
<tr>
<td>自行結束 process</td>
<td>void</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line"><span class="built_in">exit</span>(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">curproc</span> = <span class="title">myproc</span>();</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(curproc == initproc)</span><br><span class="line">    panic(<span class="string">"init exiting"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Close all open files.</span></span><br><span class="line">  <span class="keyword">for</span>(fd = <span class="number">0</span>; fd &lt; NOFILE; fd++){</span><br><span class="line">    <span class="keyword">if</span>(curproc-&gt;ofile[fd]){</span><br><span class="line">      fileclose(curproc-&gt;ofile[fd]);</span><br><span class="line">      curproc-&gt;ofile[fd] = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  begin_op();</span><br><span class="line">  iput(curproc-&gt;cwd);</span><br><span class="line">  end_op();</span><br><span class="line">  curproc-&gt;cwd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;ptable.lock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parent might be sleeping in wait().</span></span><br><span class="line">  wakeup1(curproc-&gt;parent);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Pass abandoned children to init.</span></span><br><span class="line">  <span class="keyword">for</span>(p = ptable.proc; p &lt; &amp;ptable.proc[NPROC]; p++){</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;parent == curproc){</span><br><span class="line">      p-&gt;parent = initproc;</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;state == ZOMBIE)</span><br><span class="line">        wakeup1(initproc);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Jump into the scheduler, never to return.</span></span><br><span class="line">  curproc-&gt;state = ZOMBIE;</span><br><span class="line">  sched();</span><br><span class="line">  panic(<span class="string">"zombie exit"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>首先須取得鎖。</li>
<li>喚醒父 process，將子 process 交給 <em>initproc</em>，修改狀態，呼叫 <code>sched</code> switch 至 scheduler。</li>
</ul>
<hr>
<h3 id="kill">kill<a class="header-anchor" href="#kill">#</a></h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>功能</th>
<th>回傳值</th>
<th><code>pid</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>使 process 終止</td>
<td>0 (ok) / -1 (err)</td>
<td>欲終止的 process id</td>
</tr>
</tbody>
</table></div>
<figure class="highlight c line-number"><table><tbody><tr><td class="gutter"><pre><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">kill(<span class="keyword">int</span> pid)</span><br><span class="line">{</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;ptable.lock);</span><br><span class="line">  <span class="keyword">for</span>(p = ptable.proc; p &lt; &amp;ptable.proc[NPROC]; p++){</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;pid == pid){</span><br><span class="line">      p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">      <span class="comment">// Wake process from sleep if necessary.</span></span><br><span class="line">      <span class="keyword">if</span>(p-&gt;state == SLEEPING)</span><br><span class="line">        p-&gt;state = RUNNABLE;</span><br><span class="line">      release(&amp;ptable.lock);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  release(&amp;ptable.lock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>kill</code> 將 <code>p-&gt;killed</code> 設為 1 ，當此 process 發生中斷或是 system call 進入 kernel，離開時 <code>trap</code> 會檢查 <code>p-&gt;killed</code>，如果被設置了，則呼叫 <code>exit</code>。</li>
<li>當要被 kill 的 process 處於睡眠狀態，則喚醒它。</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>

            <!-- Post information -->
            
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 post-tags">
        
            <i class="fas fa-tag" style="vertical-align: middle;font-size: .8rem;"></i>
            tags:&nbsp;
            
            
        
            <a href="/tags/kernel/">#kernel</a> <a href="/tags/scheduler/">#scheduler</a> <a href="/tags/XV6/">#XV6</a>
        
    </div>

            
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
        <ul class="pagination d-block text-center">
            
                <li class="previous page-item d-inline"><a href="/posts/xv6/fs.html" class="page-link float-left">&larr;  下一頁</a></li>
            
            
                <li class="next page-item d-inline"><a href="/posts/xv6/lock.html" class="page-link float-right">上一頁  &rarr;</a></li>
            
        </ul>
    </div>


            
                <!-- Comments -->
                
    
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
        <div id="gitalk-container"></div>
    </div>

    <script>
        let gitalk = new Gitalk({
            clientID: '97c34b7bba491c6a5007',
            clientSecret: '6140d208bae6bbbc69c65e3e332a46d090094fc8',
            repo: 'HackTech',
            owner: 'luswdev',
            admin: "luswdev",
            id: '2018-08-14 14:14:42',
            title: 'XV6 - Scheduling',
            distractionFreeMode: false  // Facebook-like distraction free mode
        });
        gitalk.render('gitalk-container');
    </script>


                

            

        </div>
    </div>
</article> 


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    <style>
        #toc-content .toc-link::before {
            background-color: transparent;
            max-height: 25px;
        }

        #toc-content .toc-link.is-active-link::before {
            background-color: #404040;
        }
    </style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <div class="ui-toc dropup scrollspy-body pull-right" style="right: 3%;">
        <button type="button" class="toc-btn btn btn-light" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-display="static">
            <i class="fas fa-list"></i>
        </button>
        <div class="dropdown-menu dropdown-menu-right p-2" aria-labelledby="tocLabel">
            <div class="toc-widget">
                <div id="toc-content" class="text-truncate">
                </div>
            </div>
            <div class="toc-menu pt-3 pl-4">
                <a class="expand-toggle d-block py-1" href="#"><span class="expand-text">全部展開</span><span class="close-text" style="display: none;">全部收起</span></a>
                <a class="back-to-top d-block py-1" href="#">回到頂部</a>
                <a class="go-to-bottom d-block py-1" href="#">移至底部</a>
            </div>
        </div>
    </div>
    <script>
        tocbot.init({
            // Where to render the table of contents.
            tocSelector: '#toc-content',
            // Where to grab the headings to build the table of contents.
            contentSelector: 'article',
            // Which headings to grab inside of the contentSelector element.
            headingSelector: 'h1, h2, h3',
            // For headings inside relative or absolute positioned containers within content.
            hasInnerContainers: true,
        });
    </script>


    


    <!-- Footer -->
    <hr>

<!-- Footer -->
<footer id="footer">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 text-center">
                <ul class="list-inline">
                    

                    

                    
                        <li class="list-inline-item">
                            <a rel="external" href="https://github.com/luswdev" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li class="list-inline-item">
                            <a rel="external" href="https://www.linkedin.com/in/callum-lu" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li class="list-inline-item">
                            <a rel="external" href="mailto:info@lusw.dev" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>
                <ul class="copyright footer-menu list-inline">
                    
                    
                        <li class="list-inline-item">
                            
                            
                            <a href="/">
                                
                                    Home
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/archives">
                                
                                    Archives
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/tags">
                                
                                    Tags
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/categories">
                                
                                    Categories
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/about">
                                
                                    About
                                
                            </a>
                        </li>
                    
                </ul>
                <p class="copyright footer-author">
                    &copy; 2018-2021 
                    <a rel="external" class="copyright-link" href="https://github.com/luswdev" target="_blank">LuSkywalker</a><br>
                    Powered by <a rel="external" class="copyright-link" href="https://hexo.io/" target="_blank">Hexo</a>  
                    <span class="copyright-split">&nbsp;|&nbsp;&nbsp;</span>
                    Theme <a rel="external" class="copyright-link" href="https://github.com/luswdev/hexo-theme-clean.git" target="_blank">Clean</a>
                    
                    
                </p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    <!-- jQuery -->
<script src="//cdn.jsdelivr.net/npm/jquery@2.1.4/dist/jquery.min.js"></script>

<!-- For drop down -->
<script src="//cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>

<!-- Bootstrap -->
<script src="//cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"></script>
<!-- Gallery -->
<script src="//cdn.jsdelivr.net/npm/lightgallery@1.6.11/dist/js/lightgallery-all.min.js"></script>
<!-- Busuanzi -->


<!-- Search script -->
<script src="/js/search.js"></script>
<script type="text/javascript">
    $(function () {
        searchFunc( '/search.xml' , 'searchInput', 'searchResult');
    });
</script>


<script src="/js/main.js"></script>


    <!-- Search Modal -->
    <!-- Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content overflow-auto">
            <div class="modal-header">
                <input type="text" class="form-control" placeholder="搜尋關鍵字..." id="searchInput">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="searchResult">
                    <div class="search-empty text-center text-muted p-5">
                        <i class="far fa-meh"></i>
                    </div>
                </div>
            </div> 
        </div>
    </div>
</div><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</body>
</html>